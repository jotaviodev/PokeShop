<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho - PokeShop</title>
    <link rel="stylesheet" href="./cart.css" />
    <link href="https://fonts.googleapis.com/css2?family=Rubik&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <script src="../js/api.js"></script>
    <script src="../js/common.js"></script>
    <style>
        .remove-item-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .remove-item-btn:hover {
            background-color: #c0392b;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity-btn {
            background-color: #3498db;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .quantity-btn:hover {
            background-color: #2980b9;
        }
        .empty-cart {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .auth-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .logout-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <a href="../index.html">
                <img src="../assets/pokelogo.png" alt="Logo PokeShop" />
            </a>
        </div>
        <div class="nav-item">
            <div class="nav-sessao">
                <a href="../pages/cart.html" title="Carrinho">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span>Carrinho</span>
                    <span class="cart-counter" style="background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; margin-left: 5px; display: none;">0</span>
                </a>
            </div>
            <div class="nav-sessao" id="authSection">
                <a href="../auth/signIn.html">Entrar</a>
            </div>
        </div>
    </nav>
    
    <div class="container-cart">
        <div class="auth-warning" id="authWarning" style="display: none;">
            <h4><i class="fa-solid fa-exclamation-triangle"></i> Acesso Restrito</h4>
            <p>Para visualizar e gerenciar seu carrinho, você precisa estar logado.</p>
            <a href="../auth/signIn.html" class="btn-voltar" style="background: #3498db; text-decoration: none; padding: 10px 20px; color: white; border-radius: 5px;">
                Fazer Login
            </a>
        </div>

        <div class="user-info" id="userInfo" style="display: none;">
            <h3>Bem-vindo(a), <span id="userName"></span>!</h3>
            <p>Email: <span id="userEmail"></span></p>
            <button onclick="logout()" class="logout-btn">
                <i class="fa-solid fa-sign-out-alt"></i> Sair
            </button>
        </div>

        <section class="cart-section" id="cartSection" style="display: none;">
            <div class="container-wrapper-items">
                <h2 class="cart-title">Carrinho de compras</h2>

                <div class="cart-items">
                    <div id="emptyCartMessage" class="empty-cart" style="display: none;">
                        <i class="fa-solid fa-shopping-cart" style="font-size: 48px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>Seu carrinho está vazio</h3>
                        <p>Adicione alguns produtos incríveis da nossa loja!</p>
                        <a href="../index.html" class="btn-voltar" style="background: #3498db; text-decoration: none; padding: 10px 20px; color: white; border-radius: 5px;">
                            Continuar Comprando
                        </a>
                    </div>
                    
                    <table class="wrapper-table" id="cartTable" style="display: none;">
                        <tbody id="cartItemsContainer">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <section class="cart-resume-section" id="cartResumeSection" style="display: none;">
            <div class="container-resume">
                <h3 class="resume-title">Resumo do Pedido</h3>
                <div class="content-resume">
                    <p class="itemns-resume">Total de Itens: <span id="totalItems">0</span></p>
                    <p class="value-resume">Total: <strong id="totalValue">R$ 0,00</strong></p>
                    <button class="finish-button" id="finishButton" onclick="finishPurchase()">Finalizar Compra</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (!AuthManager.isLoggedIn()) {
                document.getElementById('authWarning').style.display = 'block';
                document.getElementById('authSection').innerHTML = '<a href="../auth/signIn.html">Entrar</a>';
                return;
            }

            try {
                await loadUserInfo();
                loadCartItems();
                document.getElementById('cartSection').style.display = 'block';
                document.getElementById('authSection').innerHTML = '<span>Bem-vindo!</span>';
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                NotificationManager.show('Erro ao carregar dados. Faça login novamente.', 'error');
                AuthManager.logout();
            }
        });

        async function loadUserInfo() {
            try {
                const userInfo = await ApiClient.getPerfil();
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userName').textContent = userInfo.nome || 'Usuário';
                document.getElementById('userEmail').textContent = userInfo.email;
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                throw error;
            }
        }

        function loadCartItems() {
            const cartItems = CartManager.getCart();
            renderCartItems(cartItems);
            updateCartSummary(cartItems);
        }

        function renderCartItems(cartItems) {
            const container = document.getElementById('cartItemsContainer');
            const emptyMessage = document.getElementById('emptyCartMessage');
            const cartTable = document.getElementById('cartTable');
            const cartResumeSection = document.getElementById('cartResumeSection');
            
            if (cartItems.length === 0) {
                emptyMessage.style.display = 'block';
                cartTable.style.display = 'none';
                cartResumeSection.style.display = 'none';
                return;
            }

            emptyMessage.style.display = 'none';
            cartTable.style.display = 'table';
            cartResumeSection.style.display = 'block';

            container.innerHTML = cartItems.map(item => `
                <tr class="item" data-item-id="${item.id}">
                    <td>
                        <div class="content-item">
                            <a href="card.html?id=${item.id}">
                                <img src="${item.url_imagem}" alt="${item.nome}" style="width: 80px; height: 100px; object-fit: cover;"/>
                            </a>
                            <div class="product-info-left">
                                <p class="product-description">${item.nome}</p>
                                <p class="product-details">${item.tipo || 'Carta Pokémon'}</p>
                            </div>
                            <div class="product-info-right">
                                <p class="product-value">Preço: R$ ${item.valor.toFixed(2).replace('.', ',')}</p>
                                <div class="product-amount">
                                    <div class="quantity-controls">
                                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">-</button>
                                        <input type="number" min="1" max="100" value="${item.quantidade}" 
                                               onchange="setQuantity(${item.id}, this.value)" style="width: 60px; text-align: center;">
                                        <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                                        <button class="remove-item-btn" onclick="removeItem(${item.id})">
                                            <i class="fa-solid fa-trash"></i> Remover
                                        </button>
                                    </div>
                                </div>
                                <p style="font-weight: bold; margin-top: 10px;">
                                    Subtotal: R$ ${(item.valor * item.quantidade).toFixed(2).replace('.', ',')}
                                </p>
                            </div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateQuantity(itemId, change) {
            const cartItems = CartManager.getCart();
            const item = cartItems.find(item => item.id === itemId);
            
            if (item) {
                const newQuantity = item.quantidade + change;
                if (newQuantity <= 0) {
                    removeItem(itemId);
                } else if (newQuantity <= 100) {
                    CartManager.updateQuantity(itemId, newQuantity);
                    loadCartItems();
                    NotificationManager.show(`Quantidade atualizada para ${newQuantity}`, 'success');
                }
            }
        }

        function setQuantity(itemId, quantity) {
            const newQuantity = parseInt(quantity);
            if (newQuantity <= 0) {
                removeItem(itemId);
            } else if (newQuantity <= 100) {
                CartManager.updateQuantity(itemId, newQuantity);
                loadCartItems();
            } else {
                NotificationManager.show('Quantidade máxima: 100 unidades', 'warning');
                loadCartItems();
            }
        }

        function removeItem(itemId) {
            const cartItems = CartManager.getCart();
            const item = cartItems.find(item => item.id === itemId);
            
            if (item && confirm(`Deseja remover "${item.nome}" do carrinho?`)) {
                CartManager.removeItem(itemId);
                loadCartItems();
                NotificationManager.show(`${item.nome} removido do carrinho`, 'info');
            }
        }

        function updateCartSummary(cartItems) {
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantidade, 0);
            const totalValue = cartItems.reduce((sum, item) => sum + (item.valor * item.quantidade), 0);
            
            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalValue').textContent = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
        }

        function finishPurchase() {
            const cartItems = CartManager.getCart();
            
            if (cartItems.length === 0) {
                NotificationManager.show('Seu carrinho está vazio!', 'warning');
                return;
            }

            const totalValue = CartManager.getTotal();
            const itemsList = cartItems.map(item => `${item.nome} (${item.quantidade}x)`).join(', ');
            
            if (confirm(`Finalizar compra?\n\nItens: ${itemsList}\nTotal: R$ ${totalValue.toFixed(2).replace('.', ',')}`)) {
                NotificationManager.show('Compra finalizada com sucesso! Obrigado pela preferência.', 'success');
                
                CartManager.clearCart();
                loadCartItems();
                
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 3000);
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair?')) {
                AuthManager.logout();
            }
        }
    </script>
</body>
</html>